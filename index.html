<!DOCTYPE html>
<html>
<head>
    <title>BLE Plane Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        html, body { margin:0; padding:0; height:100%; width:100%; }
        #map { height:100%; width:100%; z-index:1; }
        #buttons { position: fixed; top: 10px; left: 50%; transform: translateX(-50%);
                   z-index: 9999; background: rgba(255,255,255,0.95); padding: 8px 12px;
                   border-radius: 10px; display: flex; gap: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        #buttons button { padding: 10px 18px; font-size: 15px; border: none; border-radius: 6px;
                          cursor: pointer; font-weight: bold; }
        #connectBtn { background-color:#28a745; color:white; }
        #disconnectBtn { background-color:#dc3545; color:white; }
        #spectatorBtn { background-color:#007bff; color:white; }
        #clearTrailBtn { background-color:#ffa500; color:white; }
        #legend { position: fixed; top: 70px; left: 10px; background: rgba(255,255,255,0.95);
                  padding: 10px; border-radius: 6px; z-index: 9999; font-size: 14px;
                  max-height: 300px; overflow-y: auto; }
        #status { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
                  background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 5px;
                  z-index: 9999; font-size: 14px; }
        .legend-item { cursor: pointer; margin-bottom: 4px; }
        .legend-color { display:inline-block; width:12px; height:12px; margin-right:6px; vertical-align:middle; }

        #loginBox { position: fixed; top: 150px; left: 50%; transform: translateX(-50%);
                    background: #fff; padding: 10px; border-radius: 6px; z-index: 9999;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: none; }
        #loginBox input { display: block; margin-bottom: 6px; padding: 6px; width: 200px; }
    </style>
</head>
<body>
    <div id="buttons">
        <button id="connectBtn" disabled>Connect ESP32</button>
        <button id="disconnectBtn">Disconnect All</button>
        <button id="spectatorBtn">Spectator Mode</button>
        <button id="clearTrailBtn">Clear Trails</button>
    </div>
    <div id="legend"><b>Planes:</b><br></div>
    <div id="map"></div>
    <div id="status">Initializing...</div>

    <div id="loginBox">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script>
    // ------------------- Firebase Setup -------------------
    const firebaseConfig = {
        apiKey: "AIzaSyDAuSpFwWPN39RHpd1a_f9J4eO3ktaKGhY",
        authDomain: "fir-esp-3ce92.firebaseapp.com",
        databaseURL: "https://fir-esp-3ce92-default-rtdb.firebaseio.com",
        projectId: "fir-esp-3ce92",
        storageBucket: "fir-esp-3ce92.firebasestorage.app",
        messagingSenderId: "458185267913",
        appId: "1:458185267913:web:7d0759cb3caf9a67ca0b18"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // ------------------- Auth -------------------
    function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        auth.signInWithEmailAndPassword(email, password)
            .then(user => {
                setStatus("Signed in as " + user.user.email);
                document.getElementById("loginBox").style.display = "none";
                document.getElementById("connectBtn").disabled = false;
            })
            .catch(err => alert("Login failed: " + err.message));
    }

    function logout() {
        auth.signOut().then(() => {
            setStatus("Logged out");
            if (!spectatorMode) document.getElementById("loginBox").style.display = "block";
            document.getElementById("connectBtn").disabled = true;
        });
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            setStatus("Signed in as " + user.email);
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("connectBtn").disabled = false;
        } else {
            setStatus("Not signed in");
            if (!spectatorMode) document.getElementById("loginBox").style.display = "block";
            document.getElementById("connectBtn").disabled = true;
        }
    });

    // ------------------- Map -------------------
    const map = L.map('map').setView([40.5, 23.0], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const MAX_TRAIL = 500;
    const planes = {};
    const devices = [];
    let spectatorMode = false;
    let currentFollow = null;

    function setStatus(text){ document.getElementById('status').innerText = text; }
    function getPlaneColor(id) {
        const colors = ["blue","red","green","orange","purple","brown","pink"];
        return colors[id % colors.length];
    }

    function updateLegend() {
        const legendDiv = document.getElementById('legend');
        legendDiv.innerHTML = "<b>Planes:</b><br>";
        for (let planeID in planes) {
            const plane = planes[planeID];
            const color = getPlaneColor(planeID);
            const item = document.createElement('div');
            item.className = "legend-item";
            item.innerHTML = `<span class="legend-color" style="background:${color}"></span>Plane ${planeID}`;
            item.onclick = () => {
                currentFollow = planeID;
                map.panTo(plane.marker.getLatLng(), {animate:true});
                setStatus(`Following Plane ${planeID}`);
            };
            legendDiv.appendChild(item);
        }
    }

    // ------------------- Firebase Planes -------------------
    function listenPlanes() {
        db.ref('planes').on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;

            for (let planeID in data) {
                const {lat, lng, alt=0, airspeed=0} = data[planeID];
                const pos = [lat, lng];

                if (!planes[planeID]) {
                    planes[planeID] = {
                        marker: L.marker(pos).addTo(map).bindPopup(`Plane ${planeID}`),
                        trail: [],
                        polyline: L.polyline([], { color: getPlaneColor(planeID) }).addTo(map)
                    };
                }

                const plane = planes[planeID];
                plane.marker.setLatLng(pos)
                    .bindPopup(`Plane ${planeID}<br>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}<br>Alt: ${alt.toFixed(1)} m<br>Airspeed: ${airspeed.toFixed(1)} km/h`);
                plane.trail.push(pos);
                if (plane.trail.length > MAX_TRAIL) plane.trail.shift();
                plane.polyline.setLatLngs(plane.trail);

                if (currentFollow == planeID) map.panTo(pos, { animate: true });
            }
            updateLegend();
        });
    }

    // ------------------- BLE / Collector -------------------
    const BLE_SUPPORTED = navigator.bluetooth !== undefined;
    document.getElementById('spectatorBtn').addEventListener('click', () => {
        spectatorMode = true;
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('disconnectBtn').style.display = 'none';
        document.getElementById('loginBox').style.display = 'none';
        setStatus("Spectator mode active. Viewing planes via Firebase.");
    });

    async function connectESP32() {
        if (!BLE_SUPPORTED || spectatorMode) return;
        if (!auth.currentUser) { alert("Please log in first!"); return; }
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'LoRaGPS' }],
                optionalServices: ["12345678-1234-1234-1234-1234567890ab"]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService("12345678-1234-1234-1234-1234567890ab");
            const characteristic = await service.getCharacteristic("abcd1234-5678-90ab-cdef-1234567890ab");

            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', event => {
                const value = event.target.value;
                const dataView = new DataView(value.buffer);
                const lat = dataView.getFloat32(0, true);
                const lng = dataView.getFloat32(4, true);
                const alt = dataView.getFloat32(8, true);
                const airspeed = dataView.getFloat32(12, true);
                const planeID = dataView.getUint8(16);

                db.ref('planes/' + planeID).set({ lat, lng, alt, airspeed, timestamp: Date.now() });
            });

            devices.push({device, characteristic});
            setStatus(`Connected devices: ${devices.length}`);
            alert(`Connected to ${device.name}!`);
        } catch(err) {
            console.error(err);
            setStatus("BLE connection failed.");
            alert("BLE connection failed!");
        }
    }

    async function disconnectAll() {
        for (let d of devices) if (d.device.gatt.connected) await d.device.gatt.disconnect();
        devices.length = 0;
        setStatus("Disconnected all BLE devices");
        alert("All devices disconnected!");
    }

    // ------------------- Clear Trails -------------------
    function clearTrails() {
        for (let planeID in planes) {
            planes[planeID].trail = [];
            planes[planeID].polyline.setLatLngs([]);
        }
        setStatus("All trails cleared.");
    }

    // ------------------- Event Listeners -------------------
    document.getElementById('connectBtn').addEventListener('click', connectESP32);
    document.getElementById('disconnectBtn').addEventListener('click', disconnectAll);
    document.getElementById('clearTrailBtn').addEventListener('click', clearTrails);

    // ------------------- Initialize -------------------
    listenPlanes();
    setStatus("Page loaded. Use Collector or Spectator mode.");
    </script>
</body>
</html>
