<!DOCTYPE html>
<html>
<head>
    <title>Multi-Plane & Airliner GPS Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        html, body { margin:0; padding:0; height:100%; width:100%; }
        #map { height:100%; width:100%; z-index:1; }
        #buttons {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 10px;
            display: flex;
            gap: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        #buttons button { padding: 10px 18px; font-size: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #connectBtn { background-color:#28a745; color:white; }
        #disconnectBtn { background-color:#dc3545; color:white; }
        #spectatorBtn { background-color:#007bff; color:white; }
        #legend {
            position: fixed;
            top: 70px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 10px;
            border-radius: 6px;
            z-index: 9999;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        #status { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 5px; z-index: 9999; font-size: 14px; }
        .legend-item { cursor: pointer; margin-bottom: 4px; }
        .legend-color { display:inline-block; width:12px; height:12px; margin-right:6px; vertical-align:middle; }

        /* Login box */
        #loginBox {
            position: fixed;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: #fff;
            padding: 10px;
            border-radius: 6px;
            z-index: 9999;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: none;
        }
        #loginBox input {
            display: block;
            margin-bottom: 6px;
            padding: 6px;
            width: 200px;
        }
    </style>
</head>
<body>
    <div id="buttons">
        <button id="connectBtn" disabled>Connect ESP32</button>
        <button id="disconnectBtn">Disconnect All</button>
        <button id="spectatorBtn">Spectator Mode</button>
    </div>
    <div id="legend"><b>Planes & Airliners:</b><br></div>
    <div id="map"></div>
    <div id="status">Initializing...</div>

    <!-- Login box -->
    <div id="loginBox">
        <input id="email" type="email" placeholder="Email">
        <input id="password" type="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <button onclick="logout()">Logout</button>
    </div>

    <!-- Leaflet library -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- For Leaflet rotated marker -->
    <script src="https://rawcdn.githack.com/bbecquet/Leaflet.RotatedMarker/0.2.0/leaflet.rotatedMarker.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script>
    // ------------------- Firebase Setup -------------------
    const firebaseConfig = {
        apiKey: "AIzaSyDAuSpFwWPN39RHpd1a_f9J4eO3ktaKGhY",
        authDomain: "fir-esp-3ce92.firebaseapp.com",
        databaseURL: "https://fir-esp-3ce92-default-rtdb.firebaseio.com",
        projectId: "fir-esp-3ce92",
        storageBucket: "fir-esp-3ce92.firebasestorage.app",
        messagingSenderId: "458185267913",
        appId: "1:458185267913:web:7d0759cb3caf9a67ca0b18"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // ------------------- Auth Handling -------------------
    function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        auth.signInWithEmailAndPassword(email, password)
        .then(user => {
            setStatus("Signed in as " + user.user.email);
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("connectBtn").disabled = false;
        })
        .catch(err => alert("Login failed: " + err.message));
    }

    function logout() {
        auth.signOut().then(() => {
            setStatus("Logged out");
            if (!spectatorMode) document.getElementById("loginBox").style.display = "block";
            document.getElementById("connectBtn").disabled = true;
        });
    }

    auth.onAuthStateChanged(user => {
        if (user) {
            setStatus("Signed in as " + user.email);
            document.getElementById("loginBox").style.display = "none";
            document.getElementById("connectBtn").disabled = false;
        } else {
            setStatus("Not signed in");
            if (!spectatorMode) document.getElementById("loginBox").style.display = "block";
            document.getElementById("connectBtn").disabled = true;
        }
    });

    // ------------------- Leaflet Map -------------------
    const map = L.map('map').setView([40.6401, 22.9444], 8); // Focus on Thessaloniki
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const MAX_TRAIL = 500;
    const planes = {};      // RC planes
    const airliners = {};   // AviationStack flights
    const devices = [];
    let spectatorMode = false;
    let currentFollow = null;
    let airlinersCount = 0;
    const AIRLINER_ICON = L.icon({
        iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Airplane_silhouette.svg/32px-Airplane_silhouette.svg.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
    });

    function setStatus(text) { document.getElementById('status').innerText = text; }
    function getPlaneColor(id) {
        const colors = ["blue","red","green","orange","purple","brown","pink"];
        return colors[id % colors.length];
    }

    function updateLegend() {
        const legendDiv = document.getElementById('legend');
        legendDiv.innerHTML = "<b>Planes & Airliners:</b><br>";
        // RC planes first
        for (let planeID in planes) {
            if(!planes[planeID].isAirliner) {
                const color = getPlaneColor(planeID);
                const item = document.createElement('div');
                item.className = "legend-item";
                item.innerHTML = `<span class="legend-color" style="background:${color}"></span>RC Plane ${planeID}`;
                item.onclick = () => {
                    currentFollow = planeID;
                    map.panTo(planes[planeID].marker.getLatLng(), {animate:true});
                    setStatus(`Following RC Plane ${planeID}`);
                };
                legendDiv.appendChild(item);
            }
        }
        // Airliners legend
        if(airlinersCount > 0){
            const airlinerItem = document.createElement('div');
            airlinerItem.className = "legend-item";
            airlinerItem.innerHTML = `<span class="legend-color" style="background:black"></span>Real Airliners (${airlinersCount})`;
            legendDiv.appendChild(airlinerItem);
        }
    }

    // ------------------- Firebase Listener for RC Planes -------------------
    function listenPlanes() {
        const planesRef = db.ref('planes');
        planesRef.on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;

            for (let planeID in data) {
                const lat = data[planeID].lat;
                const lng = data[planeID].lng;
                const alt = data[planeID].alt || 0;
                const airspeed = data[planeID].airspeed || 0;
                const pos = [lat, lng];

                if (!planes[planeID]) {
                    planes[planeID] = {
                        marker: L.marker(pos).addTo(map).bindPopup(`RC Plane ${planeID}`),
                        trail: [],
                        polyline: L.polyline([], { color: getPlaneColor(planeID) }).addTo(map),
                        isAirliner: false
                    };
                }

                const plane = planes[planeID];
                plane.marker.setLatLng(pos)
                    .bindPopup(`RC Plane ${planeID}<br>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}<br>Alt: ${alt.toFixed(1)} m<br>Airspeed: ${airspeed.toFixed(1)} km/h`);
                plane.trail.push(pos);
                if (plane.trail.length > MAX_TRAIL) plane.trail.shift();
                plane.polyline.setLatLngs(plane.trail);

                if (currentFollow == planeID) map.panTo(pos, { animate: true });
            }
            updateLegend();
        });
    }

    // ------------------- BLE Collector Mode -------------------
    const BLE_SUPPORTED = navigator.bluetooth !== undefined;

    document.getElementById('spectatorBtn').addEventListener('click', () => {
        spectatorMode = true;
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('disconnectBtn').style.display = 'none';
        document.getElementById('loginBox').style.display = 'none';
        setStatus("Spectator mode active. Viewing planes via Firebase and Airliners.");
    });

    async function connectESP32() {
        if (!BLE_SUPPORTED || spectatorMode) return;
        if (!auth.currentUser) { alert("Please log in first!"); return; }
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'LoRaGPS' }],
                optionalServices: ["12345678-1234-1234-1234-1234567890ab"]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService("12345678-1234-1234-1234-1234567890ab");
            const characteristic = await service.getCharacteristic("abcd1234-5678-90ab-cdef-1234567890ab");

            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handleGPSData);

            devices.push({device, characteristic});
            setStatus(`Connected devices: ${devices.length}`);
            alert(`Connected to ${device.name}!`);
        } catch(err) {
            console.error(err);
            setStatus("BLE connection failed.");
            alert("BLE connection failed!");
        }
    }

    function handleGPSData(event) {
        const value = event.target.value;
        const dataView = new DataView(value.buffer);
        const lat = dataView.getFloat32(0, true);
        const lng = dataView.getFloat32(4, true);
        const alt = dataView.getFloat32(8, true);
        const airspeed = dataView.getFloat32(12, true);
        const planeID = dataView.getUint8(16);
        const pos = [lat, lng];

        if (!planes[planeID]) {
            planes[planeID] = {
                marker: L.marker(pos).addTo(map).bindPopup(`RC Plane ${planeID}`),
                trail: [],
                polyline: L.polyline([], { color: getPlaneColor(planeID) }).addTo(map),
                isAirliner: false
            };
        }

        const plane = planes[planeID];
        plane.marker.setLatLng(pos)
            .bindPopup(`RC Plane ${planeID}<br>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}<br>Alt: ${alt.toFixed(1)} m<br>Airspeed: ${airspeed.toFixed(1)} km/h`);
        plane.trail.push(pos);
        if (plane.trail.length > MAX_TRAIL) plane.trail.shift();
        plane.polyline.setLatLngs(plane.trail);

        if (auth.currentUser) {
            db.ref('planes/' + planeID).set({
                lat: lat,
                lng: lng,
                alt: alt,
                airspeed: airspeed,
                timestamp: Date.now()
            });
        }
    }

    async function disconnectAll() {
        for (let d of devices) {
            if (d.device.gatt.connected) await d.device.gatt.disconnect();
        }
        devices.length = 0;
        setStatus("Disconnected all BLE devices");
        alert("All devices disconnected!");
    }

    document.getElementById('connectBtn').addEventListener('click', connectESP32);
    document.getElementById('disconnectBtn').addEventListener('click', disconnectAll);

    // ------------------- Thessaloniki center distance filter -------------------
    function getDistanceFromThessaloniki(lat, lng) {
        const R = 6371; // earth radius in km
        const lat1 = 40.6401 * Math.PI / 180;
        const lng1 = 22.9444 * Math.PI / 180;
        const lat2 = lat * Math.PI / 180;
        const lng2 = lng * Math.PI / 180;

        const dLat = lat2 - lat1;
        const dLng = lng2 - lng1;

        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1) * Math.cos(lat2) *
                  Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
    }

    // ------------------- AviationStack API Integration -------------------
    const AIRLINER_UPDATE_INTERVAL = 30000; // 30 seconds
    const API_KEY = '3b098191d09c6153cc3083a4028f34d8';
    const RADIUS_KM = 150; // Set radius in km

    async function fetchAirliners() {
        try {
            // Get active flights, limit 100, focused on Greece by dep_iata or arr_iata could be added if desired
            const url = `https://api.aviationstack.com/v1/flights?access_key=${API_KEY}&limit=100&flight_status=active`;

            const response = await fetch(url);
            const data = await response.json();

            if (!data.data || data.data.length === 0) {
                setStatus("No live airliners found in area.");
                return;
            }

            airlinersCount = 0;
            const existingIDs = new Set(Object.keys(airliners));
            const newIDs = new Set();

            for (const flight of data.data) {
                if (!flight.live || !flight.live.latitude || !flight.live.longitude || flight.live.is_ground) continue;

                const lat = flight.live.latitude;
                const lng = flight.live.longitude;

                // Filter by distance from Thessaloniki center
                if (getDistanceFromThessaloniki(lat, lng) > RADIUS_KM) continue;

                const id = flight.flight.icao || flight.flight.iata || flight.flight.number;
                if (!id) continue;

                newIDs.add(id);

                const alt = flight.live.altitude || 0;
                const heading = flight.live.direction || 0;
                const speed = flight.live.speed_horizontal || 0;

                const pos = [lat, lng];

                if (!airliners[id]) {
                    airliners[id] = {
                        marker: L.marker(pos, {icon: AIRLINER_ICON, rotationAngle: heading}).addTo(map)
                    };
                } else {
                    airliners[id].marker.setLatLng(pos);
                    airliners[id].marker.setRotationAngle(heading);
                }

                airliners[id].marker.bindPopup(
                    `Flight: ${flight.flight.iata || flight.flight.icao || ''}<br>` +
                    `Airline: ${flight.airline.name}<br>` +
                    `From: ${flight.departure.airport}<br>` +
                    `To: ${flight.arrival.airport}<br>` +
                    `Altitude: ${alt} m<br>` +
                    `Speed: ${speed.toFixed(1)} km/h`
                );

                airliners[id].isAirliner = true;
                planes[id] = airliners[id]; // Add to common planes object for legend consistency
                airlinersCount++;
            }

            // Remove markers for flights no longer live/found
            for(const id of existingIDs) {
                if(!newIDs.has(id)) {
                    map.removeLayer(airliners[id].marker);
                    delete airliners[id];
                    delete planes[id];
                }
            }

            updateLegend();
            setStatus(`Showing ${airlinersCount} real-time airliners within ${RADIUS_KM} km of Thessaloniki. Use Collector or Spectator mode for RC planes.`);
        } catch (e) {
            console.error(e);
            setStatus("Failed to fetch airliners data.");
        }
    }
    setInterval(fetchAirliners, AIRLINER_UPDATE_INTERVAL);
    fetchAirliners();

    // ------------------- Initialize -------------------
    listenPlanes();
    setStatus("Page loaded. Use Collector or Spectator mode.");

    </script>
</body>
</html>

