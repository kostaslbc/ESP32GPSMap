<!DOCTYPE html>
<html>
<head>
    <title>Multi-Plane & Airliner GPS Tracker with OpenSky</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
	
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>

    <script>
    // Firebase config and init (unchanged)
    const firebaseConfig = {
        apiKey: "AIzaSyDAuSpFwWPN39RHpd1a_f9J4eO3ktaKGhY",
        authDomain: "fir-esp-3ce92.firebaseapp.com",
	
    const db = firebase.database();
    const auth = firebase.auth();

    // Auth handlers (unchanged)
    function login() {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
	
        }
    });

    // Leaflet map setup
    const map = L.map('map').setView([40.6401, 22.9444], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    const MAX_TRAIL = 500;
	
    let currentFollow = null;
    let airlinersCount = 0;

    const AIRLINER_ICON = L.icon({
        iconUrl: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e9/Airplane_silhouette.svg/32px-Airplane_silhouette.svg.png',
        iconSize: [32, 32],
        iconAnchor: [16, 16],
    });
	
        if (airlinersCount > 0) {
            const airlinerItem = document.createElement('div');
            airlinerItem.className = "legend-item";
            airlinerItem.innerHTML = `<span class="legend-color" style="background:black"></span>Real Airliners (${airlinersCount})`;
            legendDiv.appendChild(airlinerItem);
        }
    }

    // Firebase plane listener (unchanged)
    function listenPlanes() {
        const planesRef = db.ref('planes');
        planesRef.on('value', snapshot => {
	
        });
    }

    // BLE Collector Mode (unchanged)
    const BLE_SUPPORTED = navigator.bluetooth !== undefined;

    document.getElementById('spectatorBtn').addEventListener('click', () => {
	
    document.getElementById('connectBtn').addEventListener('click', connectESP32);
    document.getElementById('disconnectBtn').addEventListener('click', disconnectAll);

    // Distance filter for Thessaloniki center
    function getDistanceFromThessaloniki(lat, lng) {
        const R = 6371;
        const lat1 = 40.6401 * Math.PI / 180;

        return R * c;
    }

    // OpenSky Network integration to fetch airliners near Thessaloniki
    const AIRLINER_UPDATE_INTERVAL = 30000; // 30 seconds
    const RADIUS_KM = 50; // radius around Thessaloniki center

    async function fetchAirliners() {
        try {
            // Bounding box parameter (~0.5° latitude and longitude ~50km box)
            const lamax = 40.6401 + 0.5;
            const lamin = 40.6401 - 0.5;
            const lomax = 22.9444 + 0.5;
            const lomin = 22.9444 - 0.5;

            const url = `https://opensky-network.org/api/states/all?lamax=${lamax}&lamin=${lamin}&lomax=${lomax}&lomin=${lomin}`;

            const res = await fetch(url);
            if (!res.ok) throw new Error(`OpenSky fetch error: ${res.status}`);

            const data = await res.json();
            if (!data.states) {
                setStatus("No airliner data from OpenSky.");
                return;
            }

            airlinersCount = 0;
            const existingIDs = new Set(Object.keys(airliners));
            const newIDs = new Set();
	

                if(lat === null || lng === null) continue;

                // Distance filtering for better fine-tune if desired (redundant with bounding box but safer)
                if(getDistanceFromThessaloniki(lat,lng) > RADIUS_KM) continue;

                newIDs.add(icao24);


                airliners[icao24].marker.bindPopup(
                    `Callsign: ${callsign}<br>`+
                    `Altitude: ${altitude ? altitude.toFixed(1) : "N/A"} m<br>`+
                    `Speed: ${velocity ? (velocity*3.6).toFixed(1) : "N/A"} km/h<br>`+  // velocity m/s to km/h
                    `Heading: ${heading.toFixed(1)}°`
                );


            }

            updateLegend();
            setStatus(`Showing ${airlinersCount} real-time airliners within ${RADIUS_KM} km of Thessaloniki. Use Collector/Spectator mode for RC planes.`);
        } catch(err) {
            console.error(err);
            setStatus("OpenSky Network fetch error or rate limit reached.");
        }
    }

    setInterval(fetchAirliners, AIRLINER_UPDATE_INTERVAL);
    fetchAirliners();

    listenPlanes();
    setStatus("Page loaded. Use Collector or Spectator mode.");
    </script>
</body>
</html>
