<!DOCTYPE html>
<html>
<head>
    <title>Multi-Plane GPS Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        html, body { margin:0; padding:0; height:100%; width:100%; }
        #map { height:100%; width:100%; z-index:1; }
        #buttons {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            background: rgba(255,255,255,0.95);
            padding: 8px 12px;
            border-radius: 10px;
            display: flex;
            gap: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        #buttons button { padding: 10px 18px; font-size: 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #connectBtn { background-color:#28a745; color:white; }
        #disconnectBtn { background-color:#dc3545; color:white; }
        #spectatorBtn { background-color:#007bff; color:white; }
        #status { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 5px; z-index: 9999; font-size: 14px; }
    </style>
</head>
<body>
    <div id="buttons">
        <button id="connectBtn">Connect ESP32</button>
        <button id="disconnectBtn">Disconnect All</button>
        <button id="spectatorBtn">Spectator Mode</button>
    </div>
    <div id="map"></div>
    <div id="status">Initializing...</div>

    <!-- Leaflet -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <script>
    // ------------------- Firebase Setup -------------------
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function sendGPS(planeID, lat, lng) {
        db.ref('planes/' + planeID).set({
            lat: lat,
            lng: lng,
            timestamp: Date.now()
        });
    }

    // ------------------- Leaflet Map -------------------
    const map = L.map('map').setView([40.5, 23.0], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const MAX_TRAIL = 500;
    const planes = {};  // planeID -> {marker, trail, polyline}
    const devices = []; // BLE devices
    let spectatorMode = false;

    function setStatus(text) { document.getElementById('status').innerText = text; }
    function getPlaneColor(id) {
        const colors = ["blue","red","green","orange","purple","brown","pink"];
        return colors[id % colors.length];
    }

    // ------------------- Firebase Listener (Viewer / Spectator Mode) -------------------
    function listenPlanes() {
        const planesRef = db.ref('planes');
        planesRef.on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;

            for (let planeID in data) {
                const lat = data[planeID].lat;
                const lng = data[planeID].lng;
                const pos = [lat, lng];

                if (!planes[planeID]) {
                    planes[planeID] = {
                        marker: L.marker(pos).addTo(map).bindPopup(`Plane ${planeID}`),
                        trail: [],
                        polyline: L.polyline([], { color: getPlaneColor(planeID) }).addTo(map)
                    };
                }

                const plane = planes[planeID];
                plane.marker.setLatLng(pos)
                    .bindPopup(`Plane ${planeID}<br>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`);
                plane.trail.push(pos);
                if (plane.trail.length > MAX_TRAIL) plane.trail.shift();
                plane.polyline.setLatLngs(plane.trail);
            }
        });
    }

    // ------------------- BLE Collector Mode -------------------
    const BLE_SUPPORTED = navigator.bluetooth !== undefined;

    document.getElementById('spectatorBtn').addEventListener('click', () => {
        spectatorMode = true;
        document.getElementById('connectBtn').style.display = 'none';
        document.getElementById('disconnectBtn').style.display = 'none';
        setStatus("Spectator mode active. Viewing planes via Firebase.");
    });

    async function connectESP32() {
        if (!BLE_SUPPORTED || spectatorMode) return;

        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: 'LoRaGPS' }],
                optionalServices: ["12345678-1234-1234-1234-1234567890ab"]
            });

            const server = await device.gatt.connect();
            const service = await server.getPrimaryService("12345678-1234-1234-1234-1234567890ab");
            const characteristic = await service.getCharacteristic("abcd1234-5678-90ab-cdef-1234567890ab");

            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handleGPSData);

            devices.push({device, characteristic});
            setStatus(`Connected devices: ${devices.length}`);
            alert(`Connected to ${device.name}!`);
        } catch(err) {
            console.error(err);
            setStatus("BLE connection failed.");
            alert("BLE connection failed!");
        }
    }

    function handleGPSData(event) {
        const value = event.target.value;
        const dataView = new DataView(value.buffer);  // ensures compatibility
        const lat = dataView.getFloat32(0, true);
        const lng = dataView.getFloat32(4, true);
        const planeID = dataView.getUint8(8);

        const pos = [lat, lng];

        if (!planes[planeID]) {
            planes[planeID] = {
                marker: L.marker(pos).addTo(map).bindPopup(`Plane ${planeID}`),
                trail: [],
                polyline: L.polyline([], { color: getPlaneColor(planeID) }).addTo(map)
            };
        }

        const plane = planes[planeID];
        plane.marker.setLatLng(pos)
            .bindPopup(`Plane ${planeID}<br>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}`);
        plane.trail.push(pos);
        if (plane.trail.length > MAX_TRAIL) plane.trail.shift();
        plane.polyline.setLatLngs(plane.trail);

        // Push to Firebase
        sendGPS(planeID, lat, lng);
    }

    async function disconnectAll() {
        for (let d of devices) {
            if (d.device.gatt.connected) await d.device.gatt.disconnect();
        }
        devices.length = 0;
        setStatus("Disconnected all BLE devices");
        alert("All devices disconnected!");
    }

    document.getElementById('connectBtn').addEventListener('click', connectESP32);
    document.getElementById('disconnectBtn').addEventListener('click', disconnectAll);

    // ------------------- Initialize -------------------
    listenPlanes();
    setStatus("Page loaded. Use Collector or Spectator mode.");
    </script>
</body>
</html>
